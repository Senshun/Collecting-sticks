<!doctype html>

<html>

<head>


	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="author" content="Maurycy Skier" />
	<meta name="description" content="Refreshes the iframe when watched file is changed." />
	<meta name="keywords" content="html5,experiment,javascript,live,edit,socket" />
	
	<title>Live edit</title>

	
	<script src="/socket.io/socket.io.js"></script>

	<script>


		window.onload = function() {

			//href do : to url
/*
			var items = "";
			for( var i in document.location )
				items += i + ": " + document.location[i] + "\n";
			alert( items );*/

			// var url = document.location.origin.replace( /\:\d+/, "" );
			var href = document.location.href;
			var url = href.slice( 0, href.lastIndexOf( ":" ) )
			var iframe = document.getElementById( "iframe" );

			function watch() {

				var file;
				var hash = document.location.hash;

				if( hash )
					file = hash.replace( /#!\//, "" );
				else
					file = prompt( "Which file do you want to watch?", "new/" );

				if( file ) {
					socket.emit( "watch", file );
					iframe.src = url + "/" + file;
					document.location.hash = "#!/" + file;
				}

			}

			function change() {
				iframe.src = iframe.src;
				//document.title = iframe.document.body.title;
			}

			//Przy każdej zmianie łoczy nowe pliki, a starych nie anłoczy?
			window.onhashchange = watch;
			var socket = io.connect( document.location.origin );
			socket.on( "connect", watch );
			socket.on( "change", change );
			socket.on( "nofile", function( error ) {
				alert( "No such file." );
				console.log( error );
			} );
			socket.on( "disconect", function() {
				alert( "No watching. Server is down." );
			} );

		}


	</script>


	<style type="text/css">

		html, body {
			height: 100%;
		}

		body {
			border: 0;
			margin: 0;
			padding: 0;
			overflow: hidden;
		}

		iframe {
			border: 0;
			width: 100%;
			height: 100%;
		}

	</style>


</head>

<body>

	<iframe src="" id="iframe">
		Damn!
	</iframe>

</body>

</html>